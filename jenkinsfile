pipeline {
    agent any

    environment {
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')
    }

    stages {
        stage('Test Push') {
	     when {
		branch "main"
		  }
             steps {
                   echo "+ Job has been runned"
		   script {
			  sh 'printenv'	
		 	  PR = sh(returnStdout: true, script: "gh api --jq .[].number /repos/ivngmz/jenkins/commits/$GIT_COMMIT/pulls ")
                 	   echo "+ PR number -> $PR" 

                 	   if (PR != ''){

                 	       status_PR = sh(returnStdout: true, script: "gh api --jq .state /repos/ivngmz/jenkins/pulls/${PR}")
			       merged_PR = sh(returnStdout: true, script: "gh api --jq .merged /repos/ivngmz/jenkins/pulls/${PR}")
                 	       echo "++ Current PR status -> $status_PR and merged -> $merged_PR "

                 	       // Only merged PR will be checked
                 	       if ( status_PR == 'closed' && merged_PR == true ){
                 	           labels = sh(returnStdout: true, script: "gh api --jq '.labels.[].name' /repos/ivngmz/jenkins/pulls/${PR}")
                 	           echo "+++ Found label:${labels}"
				   echo "+++ This flow has been covered"
						   }
				}
			}  
                }
        }
    }
}
